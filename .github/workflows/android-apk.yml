name: Android APK

on:
  workflow_dispatch:
    inputs:
      variant:
        description: "构建变体（release 为正式签名版本；benchmark 为调试签名可安装版本）"
        type: choice
        required: true
        default: release
        options:
          - release
          - benchmark
      allow_missing_amap_key:
        description: "允许缺失高德 AMap Key（不建议正式版；缺失时地图会降级/不可用）"
        type: boolean
        required: false
        default: false
  push:
    tags:
      - "android-v*"

permissions:
  contents: read

jobs:
  build-apk:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: android
    outputs:
      artifact_name: ${{ steps.build.outputs.artifact_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK packages
        run: |
          set -euo pipefail
          # 在 bash + pipefail 下，`yes | cmd` 可能因 SIGPIPE 导致整个 pipeline 非 0。
          # 这里临时关闭 pipefail，确保以 sdkmanager 的退出码为准。
          set +o pipefail
          yes | sdkmanager --licenses
          set -o pipefail
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v3

      - name: Ensure gradlew is executable
        run: chmod +x ./gradlew

      - name: Build APK
        id: build
        shell: bash
        env:
          # Signing secrets (正式版 release 需要)
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          WAYFARER_ANDROID_KEYSTORE_PASSWORD: ${{ secrets.WAYFARER_ANDROID_KEYSTORE_PASSWORD }}
          WAYFARER_ANDROID_KEY_ALIAS: ${{ secrets.WAYFARER_ANDROID_KEY_ALIAS }}
          WAYFARER_ANDROID_KEY_PASSWORD: ${{ secrets.WAYFARER_ANDROID_KEY_PASSWORD }}
          # App runtime secrets (建议正式版必须提供)
          WAYFARER_AMAP_API_KEY: ${{ secrets.WAYFARER_AMAP_API_KEY }}
          # Inputs
          REQUESTED_VARIANT: ${{ github.event_name == 'workflow_dispatch' && inputs.variant || 'release' }}
          ALLOW_MISSING_AMAP_KEY: ${{ github.event_name == 'workflow_dispatch' && (inputs.allow_missing_amap_key == true || inputs.allow_missing_amap_key == 'true') || 'false' }}
        run: |
          set -euo pipefail

          VARIANT="$REQUESTED_VARIANT"
          echo "requested_variant=$REQUESTED_VARIANT"

          if [[ "$VARIANT" != "release" && "$VARIANT" != "benchmark" ]]; then
            echo "::error::Unknown variant: $VARIANT"
            exit 1
          fi

          is_tag_push=0
          if [[ "${GITHUB_EVENT_NAME:-}" == "push" ]]; then
            is_tag_push=1
          fi

          if [[ "$VARIANT" == "release" ]]; then
            missing=0
            for k in ANDROID_KEYSTORE_BASE64 WAYFARER_ANDROID_KEYSTORE_PASSWORD WAYFARER_ANDROID_KEY_ALIAS WAYFARER_ANDROID_KEY_PASSWORD; do
              v="${!k:-}"
              if [[ -z "${v//[[:space:]]/}" ]]; then
                echo "::error::Missing required secret/env (blank): $k"
                missing=1
              fi
            done

            if [[ -z "${WAYFARER_AMAP_API_KEY//[[:space:]]/}" ]]; then
              if [[ "$ALLOW_MISSING_AMAP_KEY" == "true" ]]; then
                echo "::notice::WAYFARER_AMAP_API_KEY is missing; proceeding because allow_missing_amap_key=true."
              else
                echo "::warning::WAYFARER_AMAP_API_KEY is missing; the map will be degraded/unavailable in release builds."
              fi
            fi

            if (( missing == 1 )); then
              if (( is_tag_push == 1 )); then
                echo "::warning::Release signing secrets missing for tag trigger; falling back to benchmark build so the workflow can succeed."
                VARIANT="benchmark"
              else
                exit 1
              fi
            fi
          fi

          echo "variant=$VARIANT"

          if [[ "$VARIANT" == "release" ]]; then
            # Secrets pasted via UI sometimes include quotes, literal "\n" escapes, or base64url chars.
            # Normalize defensively so the same secret works across environments.
            python3 - <<'PY'
            import base64
            import os
            import re
            import sys

            s = os.environ.get("ANDROID_KEYSTORE_BASE64", "")
            s = s.strip()

            # Handle possible data URI prefix.
            if "base64," in s:
                s = s.split("base64,", 1)[1]

            # Strip wrapping quotes.
            if (s.startswith('"') and s.endswith('"')) or (s.startswith("'") and s.endswith("'")):
                s = s[1:-1]

            # Convert literal escape sequences to actual separators (then stripped).
            s = s.replace("\\n", "")
            s = s.replace("\\r", "")

            # Remove any remaining whitespace.
            s = re.sub(r"\s+", "", s)

            # base64url -> base64
            s = s.replace("-", "+").replace("_", "/")

            # Pad if needed.
            s += "=" * ((4 - (len(s) % 4)) % 4)

            try:
                data = base64.b64decode(s, validate=False)
            except Exception as e:
                print(f"::error::Failed to decode ANDROID_KEYSTORE_BASE64: {e}")
                sys.exit(1)

            if not data:
                print("::error::Decoded keystore.jks is empty. 请确认 ANDROID_KEYSTORE_BASE64 是 keystore 文件的 base64。")
                sys.exit(1)

            with open("keystore.jks", "wb") as f:
                f.write(data)
            PY
            chmod 600 keystore.jks

            if [[ ! -s keystore.jks ]]; then
              echo "::error::Decoded keystore.jks is empty. 请确认 ANDROID_KEYSTORE_BASE64 是 keystore 文件的单行 base64（Linux 示例：base64 -w0 keystore.jks）。"
              exit 1
            fi

            if ! keytool -list -keystore keystore.jks -storepass "$WAYFARER_ANDROID_KEYSTORE_PASSWORD" -alias "$WAYFARER_ANDROID_KEY_ALIAS" >/dev/null 2>&1; then
              echo "::error::Keystore 校验失败：请确认 store password/alias 正确，且 ANDROID_KEYSTORE_BASE64 对应同一个 keystore。"
              echo "提示：alias 可以用本地 keytool 查看：keytool -list -keystore your.jks"
              exit 1
            fi

            export WAYFARER_ANDROID_KEYSTORE_PATH="keystore.jks"
          fi

          case "$VARIANT" in
            release) task="assembleRelease" ;;
            benchmark) task="assembleBenchmark" ;;
          esac

          ./gradlew :app:$task

          apk_path="app/build/outputs/apk/$VARIANT/app-$VARIANT.apk"
          if [[ ! -f "$apk_path" ]]; then
            echo "::error::APK not found: $apk_path"
            ls -la app/build/outputs/apk || true
            exit 1
          fi

          artifact_name="wayfarer-android-${VARIANT}-${GITHUB_REF_NAME}"
          echo "artifact_name=$artifact_name" >> "$GITHUB_OUTPUT"
          echo "apk_path=$apk_path" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.artifact_name }}
          path: android/${{ steps.build.outputs.apk_path }}
          if-no-files-found: error

  github-release:
    runs-on: ubuntu-latest
    needs: build-apk
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-apk.outputs.artifact_name }}
          path: dist

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.apk
          generate_release_notes: true
