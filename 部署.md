
# 部署说明（速查）

本文件用于快速指引 Wayfarer 的部署流程。

更完整、可直接照抄的生产部署说明（含 Nginx/systemd 示例、环境变量清单）请以仓库根目录 `README.md` 为准。

## 推荐部署形态（单机）

- Nginx 监听 `:443`（域名 `waf.pscly.cc`）
- 路由：
  - `/v1/` -> 后端 `http://127.0.0.1:8000`
  - `/` -> Web `http://127.0.0.1:3000`

## CI/CD 备注（可选）

本仓库的 GitHub Actions deploy 通过 SSH 连接 `secrets.HOST` 指定的目标机，因此：

- `HOST` 必须是**公网可达**的域名或公网 IP（GitHub-hosted runner 在外网）。
- 目标机的 `192.168.*` 这类局域网地址仅供本地识别，无法直接被 GitHub-hosted runner 访问。

## 最小检查清单

1) Backend

- 配置 PostgreSQL（生产推荐）与 `WAYFARER_DB_URL`
- 配置稳定的 JWT 签名 key：`WAYFARER_JWT_SIGNING_KEYS_JSON` + `WAYFARER_JWT_KID_CURRENT`
- 配置 CORS/COOKIE：`WAYFARER_CORS_ALLOW_ORIGIN`、`WAYFARER_DEV_COOKIE_SECURE`
- 运行迁移：`uv run alembic upgrade head`

### 迁移策略（生产建议）

为避免“代码已更新但数据库 schema 未同步”导致的 `INTERNAL_ERROR`，建议在生产环境启用启动时迁移，并开启严格模式：

- `WAYFARER_MIGRATE_ON_START=1`
- `WAYFARER_MIGRATE_STRICT=1`
- 如数据库连接不稳定或启动阶段偶发失败，可按需提高 `WAYFARER_MIGRATE_MAX_ATTEMPTS`（例如 10）。

2) Web

- 配置 `NEXT_PUBLIC_API_BASE_URL=https://waf.pscly.cc`
- 构建：`npm ci && npm run build`

3) Nginx

- 站点配置生效后执行：`nginx -t && systemctl reload nginx`

## 排障

生产出现 `INTERNAL_ERROR` 且怀疑迁移/配置问题时，可在仓库根目录执行排障脚本收集证据。

示例（携带 `TRACE_ID`，并允许脚本执行升级/迁移）：

```bash
TRACE_ID=REPLACE_WITH_TRACE_ID DO_UPGRADE=1 bash scripts/prod_diagnose.sh
```
