## [2026-02-03 07:45] - 任务：GitHub Actions CI/CD（PR 测试 + main 自动部署）
- 原始需求：写自动 CI/CD 流水线，让每次 main 更新后自动测试 + 自动部署（SSH 到服务器后用 docker compose 部署）。
- 实现目标/逻辑：
  - 在 `.github/workflows/cicd.yml` 中实现：PR 仅跑 CI；main push 跑 CI + deploy。
  - deploy 采用双重锁：GitHub Actions concurrency + 服务器侧 lock；并加入健康检查 gate（backend `/readyz` + web `/`）。
  - SSH 连接严格启用 host key 校验（推荐用 `KNOWN_HOSTS` secret 固定 host key），避免 `StrictHostKeyChecking=no`。
  - 部署按“被测试的 SHA”发布：远端 `git fetch` 后校验 SHA 仍为 `origin/main` tip，再 checkout 指定 SHA 再 `docker compose up -d --build`。
- 核心变更（预期）：
  - 新增/修改：`.github/workflows/cicd.yml`
  - 可能新增：`.sisyphus/notepads/github-actions-cicd/*`（仅记录 AI 执行上下文，不影响产物）
- 遗留/约束：
  - 不在 PR 事件触发 deploy。
  - 不打印 `.env`/secrets 到日志。
  - 不在服务器做破坏性 git 操作（如 `git reset --hard`）除非用户明确批准。

## [2026-02-03 15:55] - 进展：补齐 deploy 回滚与本地验证
- 原始需求：同上。
- 实现目标/逻辑：
  - 在 `.github/workflows/cicd.yml` 的 SSH heredoc 远程脚本中实现：部署失败时回滚到 `PREV_SHA`，并在回滚后重新跑健康门禁。
  - 诊断输出限制为 `docker compose ps` + 关键服务 `docker compose logs --tail 200 wayfarer-backend wayfarer-web`，不 dump `.env`。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`

## [2026-02-05 15:35] - 交付：Android 改动推送 + ADB 真机安装验证
- 原始需求：安卓 App 目前无法登录导致无法同步；需要补齐登录能力并完善同步体验；并要求提交/推送到 GitHub，最后通过 ADB 安装到 `192.168.12.101:5555` 验证。
- 实现目标/逻辑：
  - Git：将 Android 登录/同步相关改动 rebase 到最新 `origin/main` 后推送（避免远端先行更新导致的 push rejected）。
  - 构建：在容器内显式使用 Java 21，并将 Gradle/Android/Kotlin 的用户目录指向 `/tmp`（适配 sandbox，避免写入 `/root/.android` 导致 `AccessDeniedException`）。
  - 安装：使用 ADB 连接 `192.168.12.101:5555` 并安装 debug APK；若遇到 `INSTALL_FAILED_UPDATE_INCOMPATIBLE`（签名不一致），先卸载旧包再安装。
- 核心变更：
  - 推送提交：`929761a`（`feat(android): 添加启动登录引导页与自动同步`）
  - 产物路径：`android/app/build/outputs/apk/debug/app-debug.apk`
- 遗留/约束：
  - debug APK 的签名依赖本机 debug keystore；若设备上已安装“不同签名”的同包名 App，将无法直接覆盖安装（需统一签名或先卸载）。
  - 新增：`.sisyphus/notepads/github-actions-cicd/*.md`（执行记录）
- 验证结果（本机）：
  - backend：`uv run pytest -q` 通过（34 passed）
  - web：`npm run lint`、`npm run build`、`npm run test:e2e` 通过
  - android：`gradlew.bat test` 通过
- 遗留/约束：
  - Task 3/4/6 依赖 GitHub Secrets/线上服务器环境，需要用户在 GitHub 设置 `KNOWN_HOSTS` 并触发一次 main run 验证。

## [2026-02-05 16:17] - 优化：固定服务器地址为 https://waf.pscly.cc（移除用户输入）
- 原始需求：用户反馈“为什么还要输入服务器地址”，要求默认使用 `https://waf.pscly.cc` 并去掉该选项。
- 实现目标/逻辑：
  - 默认值：将 debug 构建的默认 base URL 改为 `https://waf.pscly.cc`（避免真机安装 debug 包时默认指向 `10.0.2.2` 导致无法登录）。
  - 只读策略：移除 AuthGate/设置页的“服务器地址输入框 + 保存/恢复默认”能力；`ServerConfigStore.readBaseUrl()` 忽略 SharedPreferences override，仅使用 BuildConfig 注入值。
- 核心变更：
  - 修改：`android/app/build.gradle.kts`
  - 修改：`android/app/src/main/java/com/wayfarer/android/api/ServerConfigStore.kt`
  - 修改：`android/app/src/main/java/com/wayfarer/android/ui/SettingsScreen.kt`
  - 修改：`android/app/src/main/java/com/wayfarer/android/ui/auth/AuthGateScreen.kt`
- 验证：
  - Android 单测：`:app:testDebugUnitTest` 通过
  - APK：`:app:assembleDebug` 通过，并 adb 覆盖安装到 `192.168.12.101:5555`
- 遗留/约束：
  - 如需本地联调服务器，可在构建时通过 `-PWAYFARER_API_BASE_URL=...` 或环境变量 `WAYFARER_API_BASE_URL` 覆盖（非 App 内入口）。

## [2026-02-05 17:11] - 任务：Android/网页增强（隐藏服务器地址、步数统计下钻、点/区间标记）
- 原始需求：
  - Android：主页不要显示服务器地址；统计栏需要步数统计（可点击下钻看详细）；记录页启动“标记”功能（标记需标签，例如“出门买东西”，并记录 GPS；在步数统计里可看到标记时间点）。
  - Web：也需要提供相似的查看能力。
- 实现目标/逻辑（决策）：
  - 标记形态：同时支持“时间点标记”与“区间标记”（区间含开始/结束）。
  - 统计粒度：默认按天汇总（近 7/30 天），点击某天进入按小时下钻；并在下钻页展示当天标记时间线。
  - Web 范围：只做“查看统计 + 查看标记”，不做创建标记；标记由 Android 端创建并同步。
  - 数据流：Android 本地保存（Room）→ 登录后同步到后端 `life_events`；Web/Android 通过后端聚合/查询接口回看。
- 核心变更（计划落点）：
  - Android：扩展 `TrackPointEntity` 增加 `step_count/step_delta`；前台服务采集 `Sensor.TYPE_STEP_COUNTER`；新增本地 `life_events_local` 表；记录页新增标记 UI；统计页新增步数趋势与下钻。
  - Backend：`/v1/tracks/query` 返回 `step_count/step_delta`；`/v1/life-events` 支持客户端指定 `id` 并幂等；新增步数聚合接口（daily/hourly）。
  - Web：新增 `/stats` 页面展示日汇总、小时下钻与标记列表；新增对应 E2E 测试 mock。
- 遗留/约束：
  - 第一期以本机时区展示（Android/UI），后端聚合按 UTC 时间桶（后续如需按本地日界线再加 tz_offset）。

## [2026-02-05 18:04] - 交付：步数统计 + 标记（Android + Web）落地
- 原始需求：同上（隐藏服务器地址；统计需步数与下钻；记录页支持标记并在统计里可见；Web 也要能看）。
- 实现目标/逻辑（已完成）：
  - Android：
    - 记录页（主页）移除服务器地址显示；新增“标记”弹窗（时间点/区间开始）与“结束标记”按钮；区间进行中状态在主页可见。
    - 轨迹点新增步数字段：在前台服务中采集 `Sensor.TYPE_STEP_COUNTER`，按“每个位置采样点”计算 `step_count/step_delta` 并写入本地。
    - 新增本地 `life_events_local` 表保存标记（离线可用），并在同步上传时推送到后端 `life_events`（使用客户端 UUID 幂等）。
    - 统计页新增：步数总览 + 按天列表（可点击）+ 按小时下钻 + 当天标记列表。
  - Backend：
    - `/v1/tracks/query` 返回 `step_count/step_delta`。
    - `/v1/life-events` 支持客户端指定 `id` 并幂等插入（sqlite/postgresql 走 ignore/ON CONFLICT DO NOTHING）。
    - 新增 `/v1/stats/steps/daily` 与 `/v1/stats/steps/hourly`（UTC 时间桶）供 Web/未来扩展使用。
  - Web：
    - 新增 `/stats` 页面：日汇总（7/30 天）+ 点击日查看小时下钻 + life_events 列表（标记/停留等）。
    - 顶部导航新增“统计”入口。
- 核心变更（文件）：
  - Android：
    - `android/app/src/main/java/com/wayfarer/android/tracking/TrackingForegroundService.kt`
    - `android/app/src/main/java/com/wayfarer/android/db/TrackPointEntity.kt`
    - `android/app/src/main/java/com/wayfarer/android/db/WayfarerDatabase.kt`
    - `android/app/src/main/java/com/wayfarer/android/db/WayfarerDatabaseProvider.kt`
    - `android/app/src/main/java/com/wayfarer/android/db/LifeEventEntity.kt`（新增）
    - `android/app/src/main/java/com/wayfarer/android/db/LifeEventDao.kt`（新增）
    - `android/app/src/main/java/com/wayfarer/android/tracking/LifeEventRepository.kt`（新增）
    - `android/app/src/main/java/com/wayfarer/android/api/WayfarerApiClient.kt`
    - `android/app/src/main/java/com/wayfarer/android/sync/WayfarerSyncManager.kt`
    - `android/app/src/main/java/com/wayfarer/android/ui/RecordsScreen.kt`
    - `android/app/src/main/java/com/wayfarer/android/ui/StatsScreen.kt`
    - `android/app/src/main/java/com/wayfarer/android/ui/SettingsScreen.kt`
  - Backend：
    - `backend/app/api/tracks.py`
    - `backend/app/api/life_events.py`
    - `backend/app/api/stats_steps.py`（新增）
    - `backend/app/api/router.py`
    - `backend/tests/test_tracks_query.py`（补断言）
    - `backend/tests/test_life_events_idempotent.py`（新增）
    - `backend/tests/test_stats_steps.py`（新增）
  - Web：
    - `web/app/HeaderNav.tsx`
    - `web/app/stats/page.tsx`（新增）
    - `web/tests/stats.spec.ts`（新增）
- 验证：
  - Backend：`uv run pytest -q tests/test_tracks_query.py tests/test_life_events_idempotent.py tests/test_stats_steps.py` 通过（7 passed）。
  - Web：`npm run test:e2e -- tests/stats.spec.ts` 通过（注意本机环境有 `http_proxy`，运行时需加 `NO_PROXY=localhost,127.0.0.1` 以避免 localhost 走代理）。
  - Android：`./gradlew testDebugUnitTest` 通过（需用 Java 21；容器默认 Java 25 会导致 Kotlin 版本解析失败）。

## [2026-02-05 20:56] - 修复：统计明细按天倒序展示（点入日详情保持正序）
- 原始需求：查看明细时按天倒序（今天→昨天→前天…）；点进去的时间保持正序展示。
- 实现目标/逻辑：
  - Android：仅将“按天明细（点击查看）”列表按天倒序渲染；日详情仍按小时正序、标记按开始时间正序。
  - Web：`/stats` 页按天列表倒序展示；小时桶与标记列表维持接口返回顺序（正序）。
- 核心变更：
  - 修改：`android/app/src/main/java/com/wayfarer/android/ui/StatsScreen.kt`
  - 修改：`web/app/stats/page.tsx`
  - 修改：`web/tests/stats.spec.ts`
- 验证：
  - Web：`npm run build` 通过；`npm run test:e2e -- tests/stats.spec.ts` 通过（1 passed）。
  - Android：`:app:testDebugUnitTest` 通过；ADB：`adb install -r` 覆盖安装到 `192.168.12.101:5555` 并启动验证。
- 遗留/约束：
  - Web 仍按 UTC day（`YYYY-MM-DD`）展示；若需要按用户本地时区口径，需要统一前后端日期定义再改。

## [2026-02-05 21:24] - 优化：统计口径统一为本地时区（Web + Backend）
- 原始需求：按“本地时区的日期”，并要求前后端口径一致。
- 实现目标/逻辑：
  - Backend：`/v1/stats/steps/daily` 与 `/v1/stats/steps/hourly` 新增 `tz`（IANA 时区名）/`tz_offset_minutes` 参数；当 `tz` 提供时按该时区进行日/小时分桶，并返回本地日 `day` 与本地小时桶起点 `hour_start`（带 offset）。
  - Web：`/stats` 使用浏览器本地 IANA 时区（`Intl.DateTimeFormat().resolvedOptions().timeZone`）作为 `tz`；时间窗口与日详情的 start/end 按本地 0 点/23:59 计算后转为 UTC ISO 传给后端；小时与标记时间按本地时区格式化展示。
- 核心变更：
  - 修改：`backend/app/api/stats_steps.py`
  - 修改：`backend/tests/test_stats_steps.py`（新增本地时区分桶测试）
  - 修改：`web/app/stats/page.tsx`
- 验证：
  - Backend：`uv run pytest -q tests/test_tracks_query.py tests/test_life_events_idempotent.py tests/test_stats_steps.py` 通过（8 passed）。
  - Web：`npm run build` 通过；`npm run test:e2e -- tests/stats.spec.ts` 通过（1 passed）。
- 遗留/约束：
  - `tz` 由客户端传入；若未传 `tz`，后端保持旧的 UTC 分桶行为（兼容已有调用）。
  - 若用户时区存在 DST，某些日可能出现 23/25 小时；当前 hourly 接口按“本地小时序列”返回，可能出现桶数量变化（后续如需强制 24 桶可再约束）。

## [2026-02-05 22:11] - 优化：Android 统计页改为云端聚合（本地日期口径一致）
- 原始需求：继续把“本地时区日期口径”统一到 Android 端，做到 Web/Backend/Android 一致。
- 实现目标/逻辑：
  - Android：统计页步数（按天/按小时）改为调用后端聚合接口 `/v1/stats/steps/*`，并传入本机 IANA 时区 `ZoneId.systemDefault().id`；后端按该时区分桶返回 day/hour_start。
  - 回退策略：若未登录/无 token 或请求失败，则 UI 自动回退到本地统计（基于本机 TrackPoint step_delta）。
  - 指标说明：步数来自云端聚合（本地日期口径），距离/点数仍来自本机记录（避免为距离做高成本全量拉取）。
- 核心变更：
  - 新增：`android/app/src/main/java/com/wayfarer/android/tracking/StatsStepsRepository.kt`
  - 修改：`android/app/src/main/java/com/wayfarer/android/api/WayfarerApiClient.kt`（新增 steps daily/hourly API）
  - 修改：`android/app/src/main/java/com/wayfarer/android/ui/StatsScreen.kt`
- 验证：
  - Android：在本容器中需使用 Java 21（系统默认 Java 25 会导致 Kotlin DSL 报 `JavaVersion.parse(25.0.2)` 异常）：
    - `JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64 ./gradlew :app:compileDebugKotlin --no-daemon` 通过
    - `JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64 ./gradlew :app:testDebugUnitTest --no-daemon` 通过（本次为 UP-TO-DATE）
    - `JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64 ./gradlew :app:assembleDebug --no-daemon` 通过
  - ADB 安装：本轮未执行（如需可在局域网设备 `192.168.12.101:5555` 上执行 `adb install -r` 覆盖安装验证）
- 遗留/约束：
  - DST 时区：Android UI 仍固定绘制 24 个小时柱子；若遇到 23/25 小时的日，会把“重复小时”合并、缺失小时显示为 0（可接受但不完美）。

## [2026-02-05 22:19] - 体验：统计柱状图支持点选显示具体值（步数/距离）
- 原始需求：查看每小时步数（距离那边也要）时，希望点击柱状图能看到该柱的“具体步数/距离”。
- 实现目标/逻辑：
  - 交互：为 Canvas 柱状图增加 `pointerInput + detectTapGestures` 点击命中（按 `barWidth + gap` 计算 index）；命中后高亮选中柱，并在图表上方展示详情文本。
  - 覆盖范围：
    - 日详情：按小时步数图支持点选；并新增“按小时距离”图（基于本机轨迹点计算小时距离分桶）同样支持点选。
    - 总览：步数趋势 / 距离趋势两张按天柱状图支持点选显示具体数值。
- 核心变更：
  - 修改：`android/app/src/main/java/com/wayfarer/android/ui/StatsScreen.kt`
- 验证：
  - Android：使用 Java 21，`./gradlew :app:compileDebugKotlin :app:testDebugUnitTest :app:assembleDebug --no-daemon` 均通过（分次执行）。
- 遗留/约束：
  - 小时距离分桶策略：将“上一个点 → 当前点”的位移归到“上一个点所在小时”（不做跨小时拆分）；优势是实现简单且保证 24 桶之和 = 全天距离，缺点是跨小时段会有轻微归属误差（可接受）。

## [2026-02-05 22:30] - 交付：构建 benchmark APK 并 ADB 安装到真机
- 原始需求：用户反馈 APK 有点卡，希望打包 benchmark 并推送到手机验证性能表现。
- 实现目标/逻辑：
  - 构建：使用 `benchmark` buildType（基于 `release`，但用 debug keystore 签名，默认可安装）。
  - Sandbox 适配：将 Gradle/Android 用户目录指向 `/tmp`，避免写入 `/root` 下的默认目录导致权限错误：
    - `GRADLE_USER_HOME=/tmp/gradle-home`
    - `ANDROID_SDK_HOME=/tmp/android-home`
  - SDK/JDK：使用 Android SDK `ANDROID_SDK_ROOT=/root/Android/Sdk`，并固定 `JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64`。
  - 安装：`adb connect 192.168.12.101:5555`，并对 `INSTALL_FAILED_UPDATE_INCOMPATIBLE` 做兜底（签名不一致时先卸载旧包再安装）。
- 产物：
  - `android/app/build/outputs/apk/benchmark/app-benchmark.apk`
- 验证：
  - `./gradlew :app:assembleBenchmark --no-daemon` 构建成功。
  - ADB 安装成功（本次因签名不一致，卸载旧 `com.wayfarer.android` 后重装）。
- 遗留/约束：
  - Kotlin daemon 默认会尝试写入 `~/.local/share/kotlin/daemon`；在 sandbox 下会触发 `AccessDeniedException` 并回退到非 daemon 编译（可用但会有噪声日志）。如需彻底消除，可在构建时设置 `HOME` 到可写路径或在 Gradle 配置中禁用 Kotlin daemon（按需再做）。

## [2026-02-05 22:40] - 任务：Android 体验大改造（登录后全量同步 + 顶部同步条 + 设置页重做）
- 原始需求：
  - 用户反馈 APK 卡顿、体验“毛坯房”；要求“像一个非常完美好看+完善的 App”。
  - 登录后必须先同步数据；当前登录后看不到历史数据。
  - 设置页需要更好看、更完善（多页面结构）。
- 关键决策（与用户确认）：
  - 首次同步范围：全量历史（tracks + life events），采用“温和后台回填”策略。
  - 登录后不阻塞进入主界面：使用顶部同步条展示同步进度/错误/重试入口。
  - 设置页：改为多页面（账户/同步/权限/关于），开发者工具默认隐藏（About 页手势解锁）。
  - 离线模式：保留“离线继续”（可记录/查看本地数据，登录后再回填）。
- 技术路径（计划落点）：
  - Backend：为 `GET /v1/life-events` 增加分页参数（limit/offset），避免移动端全量回填一次拉太多。
  - Android：
    - SyncStateStore 扩展：记录 bootstrap/backfill 游标与阶段，供顶部同步条/设置页展示。
    - 新增 BackfillPlanner：按时间窗口分批回填，连续空窗口判定完成。
    - WayfarerApiClient 增加 life-events 拉取；WayfarerSyncManager 支持 tracks + life events 的 bootstrap 与 backfill。
    - WorkManager：新增 ACTION_BOOTSTRAP_RECENT / ACTION_BACKFILL_STEP，登录后触发 bootstrap，然后后台逐步回填。
    - UI：全局顶部 SyncBanner（同步条）；设置页重构为多页面；完善空状态与错误提示。
- 遗留/约束：
  - 保持 benchmark buildType 可用并可通过 ADB 安装到 `192.168.12.101:5555` 做性能验证。

## [2026-02-05 23:53] - 交付：登录后“全量历史同步回填”+ 顶部同步条 + 设置页多页面重构（Android 0.2.0）
- 原始需求：同上（修复登录后不同步、把毛坯房做成好看完善的 App）。
- 交付内容：
  - Backend：
    - `GET /v1/life-events` 支持分页（`limit/offset`），便于移动端回填历史时分批拉取。
  - Android：
    - 同步引擎升级：pull 同时覆盖 tracks + life events（含自动 STAY 事件），并在首次登录时启动“近期同步 + 温和后台回填”。
    - WorkManager 新增动作：
      - `bootstrap_recent`：登录后立即同步近 7 天（并先上传离线点）
      - `backfill_step`：按 7 天窗口向过去回填（APPEND 链式调度，避免 REPLACE 取消正在运行的任务）
    - 顶部同步条：全局展示同步中/回填中/失败/暂停，并提供“详情/重试/继续回填”入口。
    - 设置页重构：改为多页面（首页/账号/同步/权限/关于/开发者工具），开发者工具隐藏在“关于页版本号 7 次点击”后显示。
    - 性能：Records 页会话统计从主线程搬到后台计算（减少同步回填后首次渲染卡顿）。
  - 版本号：
    - Android `versionName`：`0.1.0` → `0.2.0`
    - Android `versionCode`：`2` → `3`
- 核心变更：
  - Backend：`backend/app/api/life_events.py`、`backend/tests/test_life_events_list_pagination.py`
  - Android：
    - Sync：`android/app/src/main/java/com/wayfarer/android/sync/*`（新增 BackfillPlanner + Worker/Scheduler/StateStore 改造）
    - API：`android/app/src/main/java/com/wayfarer/android/api/WayfarerApiClient.kt`（新增 life-events list）
    - UI：`android/app/src/main/java/com/wayfarer/android/ui/WayfarerApp.kt`（顶部同步条 + Settings 子页标题/返回）、`android/app/src/main/java/com/wayfarer/android/ui/SettingsScreen.kt`（设置页重做）、`android/app/src/main/java/com/wayfarer/android/ui/sync/*`（SyncBanner）
- 验证：
  - Backend：`uv run pytest -q tests/test_life_events_list_pagination.py ...` 通过（4 passed）。
  - Android：`./gradlew :app:testDebugUnitTest` 通过。
  - Benchmark 构建：`./gradlew :app:assembleBenchmark` 通过。
  - ADB 真机安装：已安装到 `192.168.12.101:5555`（版本 `0.2.0`/`3`）。
- 遗留/约束：
  - 同步条与设置页部分文案仍为硬编码中文（后续如需完整国际化，可统一迁移到 strings.xml）。

## [2026-02-03 16:40] - 进展：服务器预检 + host key 固定
- 原始需求：同上。
- 实现目标/逻辑：
  - 为目标机生成可用的 pinned known_hosts 条目（Windows `ssh-keyscan` 在该目标机上会因 KEX 不兼容产出空文件，因此改用一次性 `ssh -o StrictHostKeyChecking=accept-new` 写入 repo 内的 known_hosts 文件）。
  - 直接在服务器上验证 `docker compose up -d --build` 和 health endpoints。
  - 验证服务器侧 lock（flock）可阻止并发 deploy。
- 核心变更：
  - 新增：`.sisyphus/known_hosts_192.168.12.52`
  - 新增：`.sisyphus/known_hosts_u.pscly.cc`
  - 新增：`.sisyphus/tasks/github-actions-cicd.yaml`（进度跟踪）
- 验证结果：
  - 服务器：`/root/dockers/1wayfarer` 执行 `docker compose up -d --build` 成功；`curl -fsS http://127.0.0.1:18000/readyz` 与 `http://127.0.0.1:13000/` 成功。
  - 服务器锁：同一把 `/tmp/wayfarer-deploy.lock` 上 `flock` 可阻止并发获取（第二个会超时失败）。
- 遗留/约束：
  - GitHub 上目前没有 workflows（GitHub API 查询为 0），因此 Task 6 仍需把本地改动推送到 GitHub 后才能做真实的 Actions 端到端验证。

## [2026-02-03 20:33] - 进展：为 deploy SSH 失败增加脱敏诊断
- 原始需求：同上。
- 实现目标/逻辑：
  - `deploy` job 的 `Deploy (remote)` 一直“瞬时失败”，但此前把 `ssh` 的 stderr 完全重定向到 `/dev/null`，导致无法区分是 host key 校验失败、密钥认证失败、还是网络/DNS 问题。
  - 现在在 `.github/workflows/cicd.yml` 中：
    - `SSH_ERR_FILE="$(mktemp)"`
    - `ssh ... 2>"$SSH_ERR_FILE"` 捕获 stderr
    - 当 `ssh` 失败时，用内联 Python 输出“已脱敏”的 stderr 摘要（只选典型错误行，否则取前 30 行；替换 `<HOST>/<SSH_USER>/<PORT>` 占位符）。
  - 仍保持 `StrictHostKeyChecking=yes`，不打印私钥、不 dump `.env`。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`
  - 追加：`.sisyphus/notepads/github-actions-cicd/issues.md`（记录诊断策略）
- 当前状态：
  - GitHub Actions Workflow 已存在（workflow id: `229972127`，run #3 id: `21628529071`）。CI 三个 job 全部成功，但 deploy 在 `Deploy (remote)` 失败。
  - 需要将上述“脱敏诊断”提交 push 到 GitHub 后，在 Actions 页面查看该步骤输出的脱敏 stderr，从而定位根因（通常是 `Permission denied (publickey)` 或 `Host key verification failed` 等）。

## [2026-02-03 21:31] - 任务：补全 README（架构与运行手册）
- 原始需求：读取项目架构，并把仓库根目录 README.md 补充完整。
- 实现目标/逻辑：
  - 以“架构总览 -> 仓库结构 -> 运行方式 -> 配置 -> API -> 部署/CI/CD -> 排障”的顺序重写 README，确保与代码/脚本/compose/workflow 实现一致。
  - 修正历史文档漂移点：
    - 以当前路由实现为准列出接口（例如 auth 仅包含 register/login/refresh；web 侧 logout 调用为可选）。
    - Docker Compose 端口以 18000/13000 为准，并补齐健康检查与迁移开关说明。
- 核心变更：
  - 修改：README.md
- 遗留/约束：
  - 若后续新增/调整接口（例如补齐 /v1/auth/logout），需要同步更新 README 的“API 速查”。

## [2026-02-03 21:33] - 进展：README 补齐生产样例与换行/编码归一
- 原始需求：同上（补全 README）。
- 核心变更：
  - 追加：README.md 中的“生产环境变量示例 / systemd 单元 / 部署检查清单”。
  - 处理：README.md 统一为 UTF-8（无 BOM）+ LF 换行。

## [2026-02-03 21:46] - 任务：Docker 重新部署（清空 PostgreSQL 数据库）
- 原始需求：项目更新后，用 Docker 重新完整部署；清空数据库（完全不要历史数据）。
- 实现目标/逻辑：
  - 停止现有 `docker compose` 服务（`wayfarer-backend` / `wayfarer-web`）。
  - 清空数据库：连接 `WAYFARER_DB_URL` 指向的 PostgreSQL 数据库，删除全部业务数据与表结构（优先 `DROP SCHEMA public CASCADE; CREATE SCHEMA public;`；若权限允许也可直接重建数据库）。
  - 重新构建并启动：`docker compose up -d --build`；由 backend entrypoint 自动执行 `alembic upgrade head` 重建 schema。
  - 验证：检查容器健康状态 + `http://127.0.0.1:18000/readyz` 与 `http://127.0.0.1:13000/` 返回正常。
- 核心变更：无代码改动（本次为部署操作）。
- 遗留/约束：
  - 当前生产数据库为外部 PostgreSQL（不在本仓库 `docker-compose.yml` 内），清空将不可逆删除全部历史数据；请确保该库仅用于 Wayfarer。
  - 若数据库账号权限不足导致无法 drop schema/database，则降级为“按表 TRUNCATE”（需先枚举表名）。

## [2026-02-03 21:55] - 修复：PostgreSQL 迁移失败（alembic_version.version_num 长度不足）
- 现象：清库后启动 backend，`alembic upgrade head` 在写入版本号 `0003_user_admin_and_optional_email` 时失败：`value too long for type character varying(32)`，导致容器一直不健康。
- 根因：Alembic 默认把 `alembic_version.version_num` 定义为 `VARCHAR(32)`，但本项目使用可读字符串作为 revision id，长度可能超过 32。
- 解决方案：
  - 在 `backend/alembic/env.py` 中注册自定义 `WayfarerPostgresqlImpl`，让 PostgreSQL 下版本表字段使用 `VARCHAR(255)`。
  - 在 online migrations 前对已存在的库做一次“自动扩容”（若版本表已存在且仍为 32，则 ALTER 到 255），保证旧库也能平滑升级。
- 核心变更：
  - 修改：`backend/alembic/env.py`

## [2026-02-03 22:06] - 修复：迁移“看似成功但未落库”（事务边界问题）
- 现象：容器日志显示 `migration OK`，但数据库里没有任何业务表；`/readyz` 一直 503，报 `users` 表不存在。
- 根因：在 `run_migrations_online()` 中我们先执行了 `_ensure_alembic_version_num_len()`，触发 SQLAlchemy 2.x 的 autobegin 事务；若未显式提交，后续迁移可能被外层事务包住，连接关闭时整体回滚，导致“看似成功但未落库”。
- 解决方案：在 `_ensure_alembic_version_num_len()` 内部用 `with connection.begin():` 包裹执行并提交，确保进入 Alembic 迁移前连接处于干净的事务状态。
- 验证结果：
  - `docker compose up -d --build` 后 backend/web 健康；
  - `http://127.0.0.1:18000/readyz` 返回 `{"status":"ready"}`；
  - DB 业务表存在，且清库后 `users/track_points/life_events` 行数为 0。

## [2026-02-04 03:23] - 进展：CI/CD 手动触发（可选 deploy）与本地 gh 校验
- 原始需求：同上（GitHub Actions CI/CD）。
- 实现目标/逻辑：
  - 为 CI/CD 增加 `workflow_dispatch`，并引入可选输入 `deploy`（默认 false），使手动触发默认只做 CI；只有显式选择 deploy 才会执行部署，避免误点造成线上变更。
  - 为 Actions 相关验证在本机提供可复现的 `gh` CLI（仓库内 `.sisyphus/tools/gh/`），减少依赖开发机全局安装差异。
  - 将 `.sisyphus/tools/` 纳入 gitignore，保证该工具链仅作为本地/CI 辅助产物，不进入仓库产物与 PR diff。
- 核心变更：
  - 新增：`.sisyphus/tools/gh/`（本地 GitHub CLI 安装，用于验证）
  - 修改：`.gitignore`（忽略 `.sisyphus/tools/`）
  - 修改：`.github/workflows/cicd.yml`（新增 `workflow_dispatch` + `deploy` input，默认 false）
- 遗留/约束：
  - 仍保持 deploy 的默认触发来源为 `push` 到 `main`；手动触发需显式 opt-in（`deploy=true`）。

## [2026-02-04 03:50] - 任务：SSH Host Key Pinning + KNOWN_HOSTS 回退
- 原始需求：deploy job 保持 `StrictHostKeyChecking=yes`；优先使用 `secrets.KNOWN_HOSTS`，缺省时回退到仓库固定 `.github/known_hosts`（不使用 `ssh-keyscan`）；并在 deploy 后给 `issues/1/comments` 发评论报告成功/失败。
- 实现目标/逻辑：
  - 为 `deploy` job 增加 `Checkout`，以读取仓库内 `.github/known_hosts`。
  - `Setup SSH` 中：`KNOWN_HOSTS` 为空时从 `.github/known_hosts` 写入 `~/.ssh/known_hosts`，继续沿用原本的 pinned 校验逻辑。
  - deploy 结束后（`if: always()`）用 `curl` + `GITHUB_TOKEN` POST 评论，正文仅包含 deployed SHA / run URL / status。
  - 将 `deploy` job 权限最小化为 `contents: read` + `issues: write`。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`
  - 新增：`.github/known_hosts`
- 遗留/约束：
  - 本地仅做差异审查；最终以 GitHub Actions 实际运行结果为准。
  - 若 `issues/1` 不存在或权限不足，评论步骤会失败；需要确保目标 issue/PR 存在。

## [2026-02-05 11:54] - 进展：CI/CD 部署目标公网 HOST 防呆 + 预检/诊断增强
- 原始需求：继续完善 CI/CD；部署目标机在局域网为 `root@192.168.12.52`，但 GitHub Actions 在外网，需要通过公网可达入口 SSH 部署。
- 实现目标/逻辑：
  - 保持 GitHub-hosted runner -> SSH -> 服务器 `docker compose up -d --build` 的部署路径（不引入 GHCR，按你的选择走服务器本地编译）。
  - 在 workflow 增加 `HOST` 私网段防呆：若 `secrets.HOST` 是 `10.*` / `172.16-31.*` / `192.168.*` / `127.*` 等内网/回环地址，直接报错中止 deploy，避免“白跑 CI 后才发现连不上”。
  - `validate-deploy-connectivity` 预检增加重试与更明确的错误提示（仍不回显 host/port）。
  - 远端 deploy 脚本启用 BuildKit（`DOCKER_BUILDKIT=1` + `COMPOSE_DOCKER_CLI_BUILD=1`），加快并稳定构建过程。
  - 健康门禁输出增强：失败时额外输出 `last_http_code` + 单次探测摘要（不 dump body）。
  - 失败诊断补充：`docker compose images`。
  - deploy status 评论改为 best-effort：评论失败仅 `::warning::`，不再影响 deploy job 成败。
  - SSH 私钥 secret 增加兼容：优先 `CI`，为空则回退 `SSH_PRIVATE_KEY`。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`
  - 修改：`README.md`（CI/CD 章节补充 `HOST` 必须公网可达）
  - 修改：`部署.md`（补充 CI/CD 备注）
- 遗留/约束：
  - 若未来改为 self-hosted runner / VPN 等允许 GitHub runner 直连内网地址，需要同步放宽/调整 `HOST` 私网段防呆规则。

## [2026-02-05 13:59] - 修复：KNOWN_HOSTS 校验兼容 hashed known_hosts
- 现象：deploy 在 `Setup SSH (key + known_hosts)` 失败：`KNOWN_HOSTS missing usable pinned host key entry for deploy target`（执行很快就失败）。
- 根因：此前用 awk 直接解析 `~/.ssh/known_hosts` 的第一列来匹配 `secrets.HOST`。若用户使用 `ssh-keyscan -H` 生成 hashed known_hosts（第一列形如 `|1|...`），awk 无法反查到原始 host，导致误判为“缺失 pinned 条目”。
- 解决方案：
  - 将 known_hosts 校验逻辑改为 `ssh-keygen -F` 查找（可匹配 hashed/非 hashed/marker 条目），并且不回显 host。
  - 对非 22 端口，若缺少 `[host]:port` 条目，则从匹配到的 host 条目中提取 `keytype + key` 自动补一条 bracket form。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`

## [2026-02-05 14:10] - 修复：HOST 使用域名/IP 切换导致 pinned known_hosts 校验失败
- 现象：在 `ssh-keygen -F` 之后仍报：`Pinned known_hosts missing entry for deploy target (secrets.HOST / secrets.PORT)`。
- 根因：`secrets.HOST` 与 pinned known_hosts 中记录的“主机名标签”不一致（常见：pinned 文件里是内网 IP/某个域名，但 secrets.HOST 配成公网 IP/另一个域名）。虽然 host key 可能相同，但 StrictHostKeyChecking 需要 known_hosts 里存在该 host 的条目。
- 解决方案：
  - 在 `Setup SSH` 增加安全的“auto-alias”逻辑：若 pinned known_hosts 中只有 **1 个唯一的 host key**（`keytype + key`），则自动为当前 `secrets.HOST` 追加一条别名记录（并在 `PORT != 22` 时同时追加 `[host]:port` 形式），从而支持在域名/IP 之间切换而不需要每次手动改 known_hosts。
  - 若 pinned known_hosts 存在多个不同 key，则仍严格失败并提示用户更新 `secrets.KNOWN_HOSTS` 或 `.github/known_hosts`（避免猜错 key）。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`

## [2026-02-05 14:33] - 加固：合并 repo + secret known_hosts，并用 repo key 自动补 alias
- 现象：用户仍持续遇到 `Pinned known_hosts missing entry for deploy target`，多发生于 `secrets.KNOWN_HOSTS` 里包含多主机/多 key 类型（例如直接粘贴整份 known_hosts），导致之前“仅当唯一 key 才 auto-alias”的策略无法触发。
- 解决方案：
  - 写入 `~/.ssh/known_hosts` 时不再二选一覆盖，而是**合并**：优先写入仓库 `.github/known_hosts`（若存在），再追加 `secrets.KNOWN_HOSTS`（若存在）。
  - 若 `secrets.HOST` 在合并后的 known_hosts 中仍找不到，则使用仓库 `.github/known_hosts` 中的 key（优先 `ssh-ed25519`）自动为 `secrets.HOST` 追加 alias 行；仍保持 `StrictHostKeyChecking=yes`，不会接受未知 key。
  - 失败时追加一条不泄露 host 的调试信息：pinned_known_hosts_lines。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`

## [2026-02-05 14:55] - 修复：Deploy(remote) here-doc EOF 缩进导致语法错误
- 现象：GitHub Actions 日志报：
  - `here-document ... delimited by end-of-file (wanted 'EOF')`
  - `syntax error: unexpected end of file`
- 根因：`Deploy (remote)` step 里 `ssh ... <<'EOF'` 的 here-doc 结束标记 `EOF` 被多缩进了 2 个空格（不是脚本行首），Bash 无法识别结束符，导致 here-doc 一直读到文件末尾而语法报错。
- 解决方案：将 `EOF` 结束标记对齐到脚本行首（与 `PY` 结束标记一致的缩进层级），确保 Bash 能正确闭合 here-doc。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`

## [2026-02-05 12:10] - 任务：Android 登录能力修复 + 自动同步完善
- 原始需求：安卓 App 目前“没法登录”，导致无法进行同步；需要至少有稳定可用的登录功能，并把整体体验完善一些。
- 实现目标/逻辑（决策已锁定）：
  - 启动引导：未登录时优先展示登录/注册引导页；允许“离线继续”进入主界面，但明确提示未登录无法同步。
  - 错误可读：Android 解析后端标准错误包 `{code,message,trace_id}` + `X-Trace-Id`，将常见认证错误映射为中文提示，并提供可复制的诊断信息（含 trace_id）。
  - 自动同步：登录后使用 WorkManager 周期性执行“上传 pending + 增量拉取”；同时保留设置页的手动同步入口用于排障。
  - 并发风险控制：为同步链路加进程内互斥锁，避免并发 refresh 导致服务端判定 refresh reuse（`AUTH_REFRESH_REUSED`）。
- 核心变更（预期）：
  - Android：新增启动 Auth Gate UI、增强 `ApiException`/错误解析、引入 WorkManager 同步 Worker 与调度器、调整设置页登录/登出/同步逻辑。
- 遗留/约束：
  - release/benchmark 构建不支持 HTTP（仅 debug 允许 cleartext）；需要通过 UI 给出明确提示，避免“看似保存成功但无法连接”的误解。

## [2026-02-05 14:55] - 进展：Android 登录引导 + WorkManager 同步落地并通过单测
- 实现结果：
  - 启动引导：新增 `AuthGateScreen` + `AuthGateStore`，并在 `WayfarerApp` 根组件做登录门禁；支持“离线继续”，退出登录会回到引导页。
  - 错误可读：`WayfarerApiClient` 为每个请求注入 `X-Trace-Id`；解析错误包并扩展 `ApiException`；UI 统一用 `UiErrorFormatter` 输出中文提示，并提供“复制错误详情”按钮。
  - 自动同步：引入 WorkManager（`WayfarerSyncWorker` + `WayfarerSyncScheduler`），登录后自动调度周期同步；登录成功会额外触发一次 one-time sync（尽快跑一次）。
  - 并发控制：新增 `SyncRunLock`，手动同步与 Worker 互斥，降低 refresh 并发导致的 `AUTH_REFRESH_REUSED` 风险。
  - 服务器地址：`ServerConfigStore.normalizeBaseUrlOrNull()` 会剥离路径（例如输入含 `/v1`），并在 UI 保存时做校验；非 debug 构建禁止保存 `http://`（并提示原因）。
  - 版本号：Android 端版本号提升至 `0.1.0`（`versionCode=2`），便于真机覆盖安装与升级。
- 核心改动文件：
  - Android UI：`android/app/src/main/java/com/wayfarer/android/ui/WayfarerApp.kt`、`android/app/src/main/java/com/wayfarer/android/ui/SettingsScreen.kt`
  - Auth Gate：`android/app/src/main/java/com/wayfarer/android/ui/auth/AuthGateScreen.kt`、`android/app/src/main/java/com/wayfarer/android/ui/auth/AuthGateStore.kt`
  - API：`android/app/src/main/java/com/wayfarer/android/api/WayfarerApiClient.kt`、`android/app/src/main/java/com/wayfarer/android/api/ApiException.kt`、`android/app/src/main/java/com/wayfarer/android/api/ApiErrorParser.kt`、`android/app/src/main/java/com/wayfarer/android/api/ServerConfigStore.kt`
  - Sync：`android/app/src/main/java/com/wayfarer/android/sync/WayfarerSyncManager.kt`、`android/app/src/main/java/com/wayfarer/android/sync/SyncRunLock.kt`、`android/app/src/main/java/com/wayfarer/android/sync/WayfarerSyncWorker.kt`、`android/app/src/main/java/com/wayfarer/android/sync/WayfarerSyncScheduler.kt`
  - 资源/依赖：`android/app/src/main/res/values/strings.xml`、`android/app/build.gradle.kts`
  - 单测：`android/app/src/test/java/com/wayfarer/android/api/*Test.kt`
  - 构建稳定性：`android/gradle/wrapper/gradle-wrapper.properties`（timeout + 使用更稳定的镜像）
- 验证：
  - 运行 `android` 单测：`./gradlew test --no-daemon` 通过（在容器里使用 Java 21，并将 Gradle/Android/Kotlin 的用户目录指向可写路径以适配 sandbox）。
- 遗留/约束：
  - 容器默认 Java 版本为 25，Kotlin/Gradle Kotlin DSL 在该版本下可能不兼容；建议开发/CI 使用 Java 21（或 17）。

## [2026-02-05 15:16] - 加强：SSH 认证失败的可观测性（fingerprint + -vv 脱敏调试）
- 现象：deploy 进入 SSH 阶段后失败：`Permission denied (publickey,password)`，仅凭这一行无法判断是“secret 私钥不对/格式不对/被加密”还是“服务器 authorized_keys 缺失/禁用 root 登录/账号不对”。
- 解决方案：
  - 在 `Setup SSH` 输出部署用私钥的 **fingerprint**（安全，不泄漏私钥），用于在服务器上比对 `~/.ssh/authorized_keys` 是否包含对应公钥。
  - 当失败看起来是认证问题时（grep `permission denied` 等），追加一次 `ssh -vv` 的“仅认证”探测（执行 `true`），并输出脱敏后的关键行（Offering key / Server accepts key / Load key / No more authentication methods 等），帮助快速定位根因。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`

## [2026-02-05 16:48] - 任务：修复 deploy 的 SSH 认证失败并完善排障闭环
- 原始需求：GitHub Actions deploy 仍报 `Permission denied (publickey,password)`；用户希望“深度检查、补齐排障信息、修完再提交 push”。
- 实现目标/逻辑：
  - 在不降低安全性的前提下（继续 `StrictHostKeyChecking=yes`，不打印 secrets/.env），让失败信息足够自解释：
    - 明确区分“连错机器/Host Key 不匹配”与“认证失败/Key 不被接受”。
    - 给出可操作的下一步（如何用 fingerprint 对齐 `authorized_keys`、如何从服务器日志定位失败原因）。
  - 继续保持：服务器本地 `docker compose up -d --build`（不引入 GHCR）。
- 核心变更（计划）：
  - 修改：`.github/workflows/cicd.yml`（在 SSH auth failure 场景输出更明确的指引与诊断）
  - 修改：`README.md`/`部署.md`（补充 SSH 权限/host 指向/日志排障说明）
- 遗留/约束：
  - 若根因是 GitHub Secrets（私钥不对/对应公钥未上服务器）或公网入口指向错误，需要用户在 GitHub/服务器侧同步调整；Workflow 仅提供“证据与操作指引”。

## [2026-02-05 16:57] - 进展：增强 deploy 可观测性 + 文档排障闭环
- 原始需求：同上（deploy SSH 认证失败，用户要求“更深度检查后再提交”）。
- 实现目标/逻辑：
  - 将“失败时只给一句 Permission denied”升级为“可自助定位”的信息：
    - 输出 pinned **host key fingerprint**（不包含 host/IP），便于确认 runner pin 的就是目标机的 host key。
    - `ssh -vv` 脱敏摘要中额外提取并高亮：`offered_public_key_fingerprint`、`server_host_key_fingerprint`、`server_accepts_key`。
    - 补充“下一步怎么查”的提示（`authorized_keys` fingerprint 对齐、`journalctl -u ssh` 等）。
  - 增强 HOST 防呆：当 `secrets.HOST` 为域名时，在 runner 侧解析 IPv4，若全部解析为内网/保留地址则直接失败（避免公共 DNS 误配导致的“外网 runner 永远连不上”）。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`
  - 修改：`README.md`、`部署.md`
- 遗留/约束：
  - 若 `server_accepts_key=no` 且确认 host key 无误，基本可以判定为“私钥/authorized_keys 不匹配”或“sshd/防火墙对外网来源做了限制”，需要在服务器/GitHub Secrets 侧修正。
