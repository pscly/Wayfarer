## [2026-02-03 07:45] - 任务：GitHub Actions CI/CD（PR 测试 + main 自动部署）
- 原始需求：写自动 CI/CD 流水线，让每次 main 更新后自动测试 + 自动部署（SSH 到服务器后用 docker compose 部署）。
- 实现目标/逻辑：
  - 在 `.github/workflows/cicd.yml` 中实现：PR 仅跑 CI；main push 跑 CI + deploy。
  - deploy 采用双重锁：GitHub Actions concurrency + 服务器侧 lock；并加入健康检查 gate（backend `/readyz` + web `/`）。
  - SSH 连接严格启用 host key 校验（推荐用 `KNOWN_HOSTS` secret 固定 host key），避免 `StrictHostKeyChecking=no`。
  - 部署按“被测试的 SHA”发布：远端 `git fetch` 后校验 SHA 仍为 `origin/main` tip，再 checkout 指定 SHA 再 `docker compose up -d --build`。
- 核心变更（预期）：
  - 新增/修改：`.github/workflows/cicd.yml`
  - 可能新增：`.sisyphus/notepads/github-actions-cicd/*`（仅记录 AI 执行上下文，不影响产物）
- 遗留/约束：
  - 不在 PR 事件触发 deploy。
  - 不打印 `.env`/secrets 到日志。
  - 不在服务器做破坏性 git 操作（如 `git reset --hard`）除非用户明确批准。

## [2026-02-03 15:55] - 进展：补齐 deploy 回滚与本地验证
- 原始需求：同上。
- 实现目标/逻辑：
  - 在 `.github/workflows/cicd.yml` 的 SSH heredoc 远程脚本中实现：部署失败时回滚到 `PREV_SHA`，并在回滚后重新跑健康门禁。
  - 诊断输出限制为 `docker compose ps` + 关键服务 `docker compose logs --tail 200 wayfarer-backend wayfarer-web`，不 dump `.env`。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`
  - 新增：`.sisyphus/notepads/github-actions-cicd/*.md`（执行记录）
- 验证结果（本机）：
  - backend：`uv run pytest -q` 通过（34 passed）
  - web：`npm run lint`、`npm run build`、`npm run test:e2e` 通过
  - android：`gradlew.bat test` 通过
- 遗留/约束：
  - Task 3/4/6 依赖 GitHub Secrets/线上服务器环境，需要用户在 GitHub 设置 `KNOWN_HOSTS` 并触发一次 main run 验证。

## [2026-02-03 16:40] - 进展：服务器预检 + host key 固定
- 原始需求：同上。
- 实现目标/逻辑：
  - 为目标机生成可用的 pinned known_hosts 条目（Windows `ssh-keyscan` 在该目标机上会因 KEX 不兼容产出空文件，因此改用一次性 `ssh -o StrictHostKeyChecking=accept-new` 写入 repo 内的 known_hosts 文件）。
  - 直接在服务器上验证 `docker compose up -d --build` 和 health endpoints。
  - 验证服务器侧 lock（flock）可阻止并发 deploy。
- 核心变更：
  - 新增：`.sisyphus/known_hosts_192.168.12.52`
  - 新增：`.sisyphus/known_hosts_u.pscly.cc`
  - 新增：`.sisyphus/tasks/github-actions-cicd.yaml`（进度跟踪）
- 验证结果：
  - 服务器：`/root/dockers/1wayfarer` 执行 `docker compose up -d --build` 成功；`curl -fsS http://127.0.0.1:18000/readyz` 与 `http://127.0.0.1:13000/` 成功。
  - 服务器锁：同一把 `/tmp/wayfarer-deploy.lock` 上 `flock` 可阻止并发获取（第二个会超时失败）。
- 遗留/约束：
  - GitHub 上目前没有 workflows（GitHub API 查询为 0），因此 Task 6 仍需把本地改动推送到 GitHub 后才能做真实的 Actions 端到端验证。

## [2026-02-03 20:33] - 进展：为 deploy SSH 失败增加脱敏诊断
- 原始需求：同上。
- 实现目标/逻辑：
  - `deploy` job 的 `Deploy (remote)` 一直“瞬时失败”，但此前把 `ssh` 的 stderr 完全重定向到 `/dev/null`，导致无法区分是 host key 校验失败、密钥认证失败、还是网络/DNS 问题。
  - 现在在 `.github/workflows/cicd.yml` 中：
    - `SSH_ERR_FILE="$(mktemp)"`
    - `ssh ... 2>"$SSH_ERR_FILE"` 捕获 stderr
    - 当 `ssh` 失败时，用内联 Python 输出“已脱敏”的 stderr 摘要（只选典型错误行，否则取前 30 行；替换 `<HOST>/<SSH_USER>/<PORT>` 占位符）。
  - 仍保持 `StrictHostKeyChecking=yes`，不打印私钥、不 dump `.env`。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`
  - 追加：`.sisyphus/notepads/github-actions-cicd/issues.md`（记录诊断策略）
- 当前状态：
  - GitHub Actions Workflow 已存在（workflow id: `229972127`，run #3 id: `21628529071`）。CI 三个 job 全部成功，但 deploy 在 `Deploy (remote)` 失败。
  - 需要将上述“脱敏诊断”提交 push 到 GitHub 后，在 Actions 页面查看该步骤输出的脱敏 stderr，从而定位根因（通常是 `Permission denied (publickey)` 或 `Host key verification failed` 等）。

## [2026-02-03 21:31] - 任务：补全 README（架构与运行手册）
- 原始需求：读取项目架构，并把仓库根目录 README.md 补充完整。
- 实现目标/逻辑：
  - 以“架构总览 -> 仓库结构 -> 运行方式 -> 配置 -> API -> 部署/CI/CD -> 排障”的顺序重写 README，确保与代码/脚本/compose/workflow 实现一致。
  - 修正历史文档漂移点：
    - 以当前路由实现为准列出接口（例如 auth 仅包含 register/login/refresh；web 侧 logout 调用为可选）。
    - Docker Compose 端口以 18000/13000 为准，并补齐健康检查与迁移开关说明。
- 核心变更：
  - 修改：README.md
- 遗留/约束：
  - 若后续新增/调整接口（例如补齐 /v1/auth/logout），需要同步更新 README 的“API 速查”。

## [2026-02-03 21:33] - 进展：README 补齐生产样例与换行/编码归一
- 原始需求：同上（补全 README）。
- 核心变更：
  - 追加：README.md 中的“生产环境变量示例 / systemd 单元 / 部署检查清单”。
  - 处理：README.md 统一为 UTF-8（无 BOM）+ LF 换行。

## [2026-02-03 21:46] - 任务：Docker 重新部署（清空 PostgreSQL 数据库）
- 原始需求：项目更新后，用 Docker 重新完整部署；清空数据库（完全不要历史数据）。
- 实现目标/逻辑：
  - 停止现有 `docker compose` 服务（`wayfarer-backend` / `wayfarer-web`）。
  - 清空数据库：连接 `WAYFARER_DB_URL` 指向的 PostgreSQL 数据库，删除全部业务数据与表结构（优先 `DROP SCHEMA public CASCADE; CREATE SCHEMA public;`；若权限允许也可直接重建数据库）。
  - 重新构建并启动：`docker compose up -d --build`；由 backend entrypoint 自动执行 `alembic upgrade head` 重建 schema。
  - 验证：检查容器健康状态 + `http://127.0.0.1:18000/readyz` 与 `http://127.0.0.1:13000/` 返回正常。
- 核心变更：无代码改动（本次为部署操作）。
- 遗留/约束：
  - 当前生产数据库为外部 PostgreSQL（不在本仓库 `docker-compose.yml` 内），清空将不可逆删除全部历史数据；请确保该库仅用于 Wayfarer。
  - 若数据库账号权限不足导致无法 drop schema/database，则降级为“按表 TRUNCATE”（需先枚举表名）。

## [2026-02-03 21:55] - 修复：PostgreSQL 迁移失败（alembic_version.version_num 长度不足）
- 现象：清库后启动 backend，`alembic upgrade head` 在写入版本号 `0003_user_admin_and_optional_email` 时失败：`value too long for type character varying(32)`，导致容器一直不健康。
- 根因：Alembic 默认把 `alembic_version.version_num` 定义为 `VARCHAR(32)`，但本项目使用可读字符串作为 revision id，长度可能超过 32。
- 解决方案：
  - 在 `backend/alembic/env.py` 中注册自定义 `WayfarerPostgresqlImpl`，让 PostgreSQL 下版本表字段使用 `VARCHAR(255)`。
  - 在 online migrations 前对已存在的库做一次“自动扩容”（若版本表已存在且仍为 32，则 ALTER 到 255），保证旧库也能平滑升级。
- 核心变更：
  - 修改：`backend/alembic/env.py`

## [2026-02-03 22:06] - 修复：迁移“看似成功但未落库”（事务边界问题）
- 现象：容器日志显示 `migration OK`，但数据库里没有任何业务表；`/readyz` 一直 503，报 `users` 表不存在。
- 根因：在 `run_migrations_online()` 中我们先执行了 `_ensure_alembic_version_num_len()`，触发 SQLAlchemy 2.x 的 autobegin 事务；若未显式提交，后续迁移可能被外层事务包住，连接关闭时整体回滚，导致“看似成功但未落库”。
- 解决方案：在 `_ensure_alembic_version_num_len()` 内部用 `with connection.begin():` 包裹执行并提交，确保进入 Alembic 迁移前连接处于干净的事务状态。
- 验证结果：
  - `docker compose up -d --build` 后 backend/web 健康；
  - `http://127.0.0.1:18000/readyz` 返回 `{"status":"ready"}`；
  - DB 业务表存在，且清库后 `users/track_points/life_events` 行数为 0。

## [2026-02-04 03:23] - 进展：CI/CD 手动触发（可选 deploy）与本地 gh 校验
- 原始需求：同上（GitHub Actions CI/CD）。
- 实现目标/逻辑：
  - 为 CI/CD 增加 `workflow_dispatch`，并引入可选输入 `deploy`（默认 false），使手动触发默认只做 CI；只有显式选择 deploy 才会执行部署，避免误点造成线上变更。
  - 为 Actions 相关验证在本机提供可复现的 `gh` CLI（仓库内 `.sisyphus/tools/gh/`），减少依赖开发机全局安装差异。
  - 将 `.sisyphus/tools/` 纳入 gitignore，保证该工具链仅作为本地/CI 辅助产物，不进入仓库产物与 PR diff。
- 核心变更：
  - 新增：`.sisyphus/tools/gh/`（本地 GitHub CLI 安装，用于验证）
  - 修改：`.gitignore`（忽略 `.sisyphus/tools/`）
  - 修改：`.github/workflows/cicd.yml`（新增 `workflow_dispatch` + `deploy` input，默认 false）
- 遗留/约束：
  - 仍保持 deploy 的默认触发来源为 `push` 到 `main`；手动触发需显式 opt-in（`deploy=true`）。

## [2026-02-04 03:50] - 任务：SSH Host Key Pinning + KNOWN_HOSTS 回退
- 原始需求：deploy job 保持 `StrictHostKeyChecking=yes`；优先使用 `secrets.KNOWN_HOSTS`，缺省时回退到仓库固定 `.github/known_hosts`（不使用 `ssh-keyscan`）；并在 deploy 后给 `issues/1/comments` 发评论报告成功/失败。
- 实现目标/逻辑：
  - 为 `deploy` job 增加 `Checkout`，以读取仓库内 `.github/known_hosts`。
  - `Setup SSH` 中：`KNOWN_HOSTS` 为空时从 `.github/known_hosts` 写入 `~/.ssh/known_hosts`，继续沿用原本的 pinned 校验逻辑。
  - deploy 结束后（`if: always()`）用 `curl` + `GITHUB_TOKEN` POST 评论，正文仅包含 deployed SHA / run URL / status。
  - 将 `deploy` job 权限最小化为 `contents: read` + `issues: write`。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`
  - 新增：`.github/known_hosts`
- 遗留/约束：
  - 本地仅做差异审查；最终以 GitHub Actions 实际运行结果为准。
  - 若 `issues/1` 不存在或权限不足，评论步骤会失败；需要确保目标 issue/PR 存在。

## [2026-02-05 11:54] - 进展：CI/CD 部署目标公网 HOST 防呆 + 预检/诊断增强
- 原始需求：继续完善 CI/CD；部署目标机在局域网为 `root@192.168.12.52`，但 GitHub Actions 在外网，需要通过公网可达入口 SSH 部署。
- 实现目标/逻辑：
  - 保持 GitHub-hosted runner -> SSH -> 服务器 `docker compose up -d --build` 的部署路径（不引入 GHCR，按你的选择走服务器本地编译）。
  - 在 workflow 增加 `HOST` 私网段防呆：若 `secrets.HOST` 是 `10.*` / `172.16-31.*` / `192.168.*` / `127.*` 等内网/回环地址，直接报错中止 deploy，避免“白跑 CI 后才发现连不上”。
  - `validate-deploy-connectivity` 预检增加重试与更明确的错误提示（仍不回显 host/port）。
  - 远端 deploy 脚本启用 BuildKit（`DOCKER_BUILDKIT=1` + `COMPOSE_DOCKER_CLI_BUILD=1`），加快并稳定构建过程。
  - 健康门禁输出增强：失败时额外输出 `last_http_code` + 单次探测摘要（不 dump body）。
  - 失败诊断补充：`docker compose images`。
  - deploy status 评论改为 best-effort：评论失败仅 `::warning::`，不再影响 deploy job 成败。
  - SSH 私钥 secret 增加兼容：优先 `CI`，为空则回退 `SSH_PRIVATE_KEY`。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`
  - 修改：`README.md`（CI/CD 章节补充 `HOST` 必须公网可达）
  - 修改：`部署.md`（补充 CI/CD 备注）
- 遗留/约束：
  - 若未来改为 self-hosted runner / VPN 等允许 GitHub runner 直连内网地址，需要同步放宽/调整 `HOST` 私网段防呆规则。

## [2026-02-05 13:59] - 修复：KNOWN_HOSTS 校验兼容 hashed known_hosts
- 现象：deploy 在 `Setup SSH (key + known_hosts)` 失败：`KNOWN_HOSTS missing usable pinned host key entry for deploy target`（执行很快就失败）。
- 根因：此前用 awk 直接解析 `~/.ssh/known_hosts` 的第一列来匹配 `secrets.HOST`。若用户使用 `ssh-keyscan -H` 生成 hashed known_hosts（第一列形如 `|1|...`），awk 无法反查到原始 host，导致误判为“缺失 pinned 条目”。
- 解决方案：
  - 将 known_hosts 校验逻辑改为 `ssh-keygen -F` 查找（可匹配 hashed/非 hashed/marker 条目），并且不回显 host。
  - 对非 22 端口，若缺少 `[host]:port` 条目，则从匹配到的 host 条目中提取 `keytype + key` 自动补一条 bracket form。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`

## [2026-02-05 14:10] - 修复：HOST 使用域名/IP 切换导致 pinned known_hosts 校验失败
- 现象：在 `ssh-keygen -F` 之后仍报：`Pinned known_hosts missing entry for deploy target (secrets.HOST / secrets.PORT)`。
- 根因：`secrets.HOST` 与 pinned known_hosts 中记录的“主机名标签”不一致（常见：pinned 文件里是内网 IP/某个域名，但 secrets.HOST 配成公网 IP/另一个域名）。虽然 host key 可能相同，但 StrictHostKeyChecking 需要 known_hosts 里存在该 host 的条目。
- 解决方案：
  - 在 `Setup SSH` 增加安全的“auto-alias”逻辑：若 pinned known_hosts 中只有 **1 个唯一的 host key**（`keytype + key`），则自动为当前 `secrets.HOST` 追加一条别名记录（并在 `PORT != 22` 时同时追加 `[host]:port` 形式），从而支持在域名/IP 之间切换而不需要每次手动改 known_hosts。
  - 若 pinned known_hosts 存在多个不同 key，则仍严格失败并提示用户更新 `secrets.KNOWN_HOSTS` 或 `.github/known_hosts`（避免猜错 key）。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`

## [2026-02-05 14:33] - 加固：合并 repo + secret known_hosts，并用 repo key 自动补 alias
- 现象：用户仍持续遇到 `Pinned known_hosts missing entry for deploy target`，多发生于 `secrets.KNOWN_HOSTS` 里包含多主机/多 key 类型（例如直接粘贴整份 known_hosts），导致之前“仅当唯一 key 才 auto-alias”的策略无法触发。
- 解决方案：
  - 写入 `~/.ssh/known_hosts` 时不再二选一覆盖，而是**合并**：优先写入仓库 `.github/known_hosts`（若存在），再追加 `secrets.KNOWN_HOSTS`（若存在）。
  - 若 `secrets.HOST` 在合并后的 known_hosts 中仍找不到，则使用仓库 `.github/known_hosts` 中的 key（优先 `ssh-ed25519`）自动为 `secrets.HOST` 追加 alias 行；仍保持 `StrictHostKeyChecking=yes`，不会接受未知 key。
  - 失败时追加一条不泄露 host 的调试信息：pinned_known_hosts_lines。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`

## [2026-02-05 14:55] - 修复：Deploy(remote) here-doc EOF 缩进导致语法错误
- 现象：GitHub Actions 日志报：
  - `here-document ... delimited by end-of-file (wanted 'EOF')`
  - `syntax error: unexpected end of file`
- 根因：`Deploy (remote)` step 里 `ssh ... <<'EOF'` 的 here-doc 结束标记 `EOF` 被多缩进了 2 个空格（不是脚本行首），Bash 无法识别结束符，导致 here-doc 一直读到文件末尾而语法报错。
- 解决方案：将 `EOF` 结束标记对齐到脚本行首（与 `PY` 结束标记一致的缩进层级），确保 Bash 能正确闭合 here-doc。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`
