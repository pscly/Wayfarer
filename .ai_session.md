## [2026-02-03 07:45] - 任务：GitHub Actions CI/CD（PR 测试 + main 自动部署）
- 原始需求：写自动 CI/CD 流水线，让每次 main 更新后自动测试 + 自动部署（SSH 到服务器后用 docker compose 部署）。
- 实现目标/逻辑：
  - 在 `.github/workflows/cicd.yml` 中实现：PR 仅跑 CI；main push 跑 CI + deploy。
  - deploy 采用双重锁：GitHub Actions concurrency + 服务器侧 lock；并加入健康检查 gate（backend `/readyz` + web `/`）。
  - SSH 连接严格启用 host key 校验（推荐用 `KNOWN_HOSTS` secret 固定 host key），避免 `StrictHostKeyChecking=no`。
  - 部署按“被测试的 SHA”发布：远端 `git fetch` 后校验 SHA 仍为 `origin/main` tip，再 checkout 指定 SHA 再 `docker compose up -d --build`。
- 核心变更（预期）：
  - 新增/修改：`.github/workflows/cicd.yml`
  - 可能新增：`.sisyphus/notepads/github-actions-cicd/*`（仅记录 AI 执行上下文，不影响产物）
- 遗留/约束：
  - 不在 PR 事件触发 deploy。
  - 不打印 `.env`/secrets 到日志。
  - 不在服务器做破坏性 git 操作（如 `git reset --hard`）除非用户明确批准。

## [2026-02-03 15:55] - 进展：补齐 deploy 回滚与本地验证
- 原始需求：同上。
- 实现目标/逻辑：
  - 在 `.github/workflows/cicd.yml` 的 SSH heredoc 远程脚本中实现：部署失败时回滚到 `PREV_SHA`，并在回滚后重新跑健康门禁。
  - 诊断输出限制为 `docker compose ps` + 关键服务 `docker compose logs --tail 200 wayfarer-backend wayfarer-web`，不 dump `.env`。
- 核心变更：
  - 修改：`.github/workflows/cicd.yml`
  - 新增：`.sisyphus/notepads/github-actions-cicd/*.md`（执行记录）
- 验证结果（本机）：
  - backend：`uv run pytest -q` 通过（34 passed）
  - web：`npm run lint`、`npm run build`、`npm run test:e2e` 通过
  - android：`gradlew.bat test` 通过
- 遗留/约束：
  - Task 3/4/6 依赖 GitHub Secrets/线上服务器环境，需要用户在 GitHub 设置 `KNOWN_HOSTS` 并触发一次 main run 验证。

## [2026-02-03 16:40] - 进展：服务器预检 + host key 固定
- 原始需求：同上。
- 实现目标/逻辑：
  - 为目标机生成可用的 pinned known_hosts 条目（Windows `ssh-keyscan` 在该目标机上会因 KEX 不兼容产出空文件，因此改用一次性 `ssh -o StrictHostKeyChecking=accept-new` 写入 repo 内的 known_hosts 文件）。
  - 直接在服务器上验证 `docker compose up -d --build` 和 health endpoints。
  - 验证服务器侧 lock（flock）可阻止并发 deploy。
- 核心变更：
  - 新增：`.sisyphus/known_hosts_192.168.12.52`
  - 新增：`.sisyphus/known_hosts_u.pscly.cc`
  - 新增：`.sisyphus/tasks/github-actions-cicd.yaml`（进度跟踪）
- 验证结果：
  - 服务器：`/root/dockers/1wayfarer` 执行 `docker compose up -d --build` 成功；`curl -fsS http://127.0.0.1:18000/readyz` 与 `http://127.0.0.1:13000/` 成功。
  - 服务器锁：同一把 `/tmp/wayfarer-deploy.lock` 上 `flock` 可阻止并发获取（第二个会超时失败）。
- 遗留/约束：
  - GitHub 上目前没有 workflows（GitHub API 查询为 0），因此 Task 6 仍需把本地改动推送到 GitHub 后才能做真实的 Actions 端到端验证。
